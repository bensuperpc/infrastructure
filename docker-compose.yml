version: "3.8"

services:
  webserver:
    depends_on:
      - wordpress
    image: nginx:1.23
    container_name: webserver
    profiles:
      - webserver
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - wordpress:/var/www/wordpress
      - jellyfin:/var/www/jellyfin
      - ./nginx-conf:/etc/nginx/conf.d
      - certbot-cert:/etc/letsencrypt:ro
    networks:
      - app-network
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    profiles:
      - qbittorrent
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/London
      - WEBUI_PORT=8080
    volumes:
      - qbittorrent-conf:/config
      - qbittorrent-downloads:/downloads
    #ports:
    #  - 8080:8080
    #  - 6881:6881
    #  - 6881:6881/udp
    restart: unless-stopped
    networks:
      - app-network
  jellyfin:
    image: lscr.io/linuxserver/jellyfin:latest
    container_name: jellyfin
    profiles:
      - jellyfin
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/London
      - JELLYFIN_PublishedServerUrl=192.168.0.5 #optional
    volumes:
      - jellyfin-config:/config
      - jellyfin-tvseries:/data/tvshows
      - jellyfin-movies:/data/movies
      - jellyfin:/var/www/html
    #ports:
    #  - 8096:8096
    #  - 8920:8920 #optional
    #  - 7359:7359/udp #optional
    #  - 1900:1900/udp #optional
    restart: unless-stopped
    networks:
      - app-network
  certbot:
    depends_on:
      - webserver
    image: certbot/certbot:v1.32.0
    container_name: certbot
    profiles:
      - certbot
    volumes:
      - certbot-cert:/etc/letsencrypt
      - wordpress:/var/www/wordpress
      - jellyfin:/var/www/jellyfin
    #command: certonly --email bensuperpc@bensuperpc.fr --agree-tos --rsa-key-size 4096 --no-eff-email --verbose --noninteractive --staging --webroot \
    #command: certonly --email bensuperpc@bensuperpc.fr --agree-tos --rsa-key-size 4096 --no-eff-email --verbose --noninteractive --force-renewal --webroot \
    command: certonly --email bensuperpc@bensuperpc.fr --agree-tos --rsa-key-size 4096 --no-eff-email --verbose --noninteractive --keep-until-expiring --webroot \
      --webroot-path=/app --domain bensuperpc.org --domain www.bensuperpc.org \
      --webroot-path=/var/www/jellyfin --domain jellyfin.bensuperpc.org --domain www.jellyfin.bensuperpc.org \
      --webroot-path=/var/www/wordpress --domain wordpress.bensuperpc.org --domain www.wordpress.bensuperpc.org
